<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>{{ kp.title or 'Комерційна пропозиція' }}</title>
    <style>
        @page {
            size: {% if template_config and template_config.page_orientation == 'landscape' %}A4 landscape{% else %}A4{% endif %};
            margin: 10mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: {{ font_family or 'Arial, sans-serif' }};
            color: {{ text_color or '#333333' }};
            background-color: #ffffff;
            line-height: 1.3;
            font-size: 10pt;
        }
        
        .container {
            max-width: 100%;
        }
        
        /* Шапка - завантажується користувачем */
        .header-image {
            width: 100%;
            height: auto;
            margin-bottom: 0;
        }
        
        /* Головний заголовок КП */
        .main-title {
            text-align: center;
            padding: 5mm 0;
        }
        
        .main-title h1 {
            font-size: 18pt;
            font-weight: bold;
            color: {{ primary_color or '#FF5A00' }};
            text-transform: uppercase;
            margin-bottom: 3mm;
        }
        
        .manager-info {
            display: table;
            width: 100%;
            text-align: center;
        }
        
        .manager-info-row {
            display: table-row;
        }
        
        .manager-info-cell {
            display: table-cell;
            color: {{ primary_color or '#FF5A00' }};
            font-size: 10pt;
            padding: 0 5mm;
        }
        
        /* Блок інформації про клієнта */
        .client-info {
            display: table;
            width: 100%;
            margin: 5mm 0;
            padding: 3mm 0;
        }
        
        .client-info-row {
            display: table-row;
        }
        
        .client-info-col {
            display: table-cell;
            width: 50%;
            vertical-align: top;
            padding: 0 3mm;
        }
        
        .client-info-line {
            padding: 1.5mm 0;
            font-size: 10pt;
        }
        
        .client-info-label {
            font-weight: bold;
            color: #333;
        }
        
        .client-info-value {
            font-weight: bold;
        }
        
        /* Великий помаранчевий хедер секції */
        .section-header {
            background: {{ primary_color or '#FF5A00' }};
            color: white;
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            padding: 3mm;
            margin-top: 5mm;
            text-transform: uppercase;
        }
        
        /* Хедер таблиці */
        .table-header {
            display: table;
            width: 100%;
            background: {{ primary_color or '#FF5A00' }};
            color: white;
            font-size: 9pt;
            font-weight: bold;
        }
        
        .table-header-row {
            display: table-row;
        }
        
        .table-header-cell {
            display: table-cell;
            padding: 2mm;
            text-align: center;
            vertical-align: middle;
            border-right: 1px solid rgba(255,255,255,0.3);
        }
        
        .table-header-cell:last-child {
            border-right: none;
        }
        
        .table-header-cell.name-col {
            text-align: left;
            width: 35%;
        }
        
        .table-header-cell.photo-col {
            width: 15%;
        }
        
        .table-header-cell.value-col {
            width: 12.5%;
        }
        
        /* Категорія страв - пілюля */
        .category-pill {
            background: {{ primary_color or '#FF5A00' }};
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 2mm 5mm;
            margin: 3mm auto;
            border-radius: 20px;
            text-transform: uppercase;
            font-size: 10pt;
            display: table;
            width: auto;
            min-width: 50%;
        }
        
        /* Рядок страви */
        .item-row {
            display: table;
            width: 100%;
            border-bottom: 1px solid #E5E5E5;
        }
        
        .item-row-inner {
            display: table-row;
        }
        
        .item-cell {
            display: table-cell;
            padding: 3mm 2mm;
            vertical-align: middle;
            font-size: 10pt;
        }
        
        .item-cell.name-col {
            width: 35%;
            text-align: left;
        }
        
        .item-cell.photo-col {
            width: 15%;
            text-align: center;
        }
        
        .item-cell.value-col {
            width: 12.5%;
            text-align: center;
        }
        
        .item-photo {
            width: 18mm;
            height: 18mm;
            object-fit: cover;
            border-radius: 2mm;
        }
        
        /* Сірий блок підсумків */
        .summary-gray {
            background: #666666;
            color: white;
            padding: 3mm 5mm;
            margin-top: 2mm;
        }
        
        .summary-gray-line {
            padding: 1mm 0;
            font-size: 10pt;
        }
        
        .summary-gray-bold {
            font-weight: bold;
            font-size: 11pt;
        }
        
        /* Фінальний підсумок */
        .final-summary {
            background: #666666;
            color: white;
            padding: 4mm 5mm;
            margin-top: 5mm;
        }
        
        .final-summary-main {
            font-size: 14pt;
            font-weight: bold;
            padding: 2mm 0;
        }
        
        .final-summary-fop {
            font-size: 11pt;
            padding: 1mm 0;
        }
        
        /* Таблиця сервісу */
        .service-row {
            display: table;
            width: 100%;
            border-bottom: 1px solid #E5E5E5;
        }
        
        .service-cell {
            display: table-cell;
            padding: 3mm 2mm;
            vertical-align: middle;
            font-size: 10pt;
        }
        
        .service-cell.name-col {
            width: 75%;
            text-align: left;
        }
        
        .service-cell.value-col {
            width: 25%;
            text-align: right;
        }
        
        /* Умови бронювання */
        .booking-terms {
            margin-top: 8mm;
            padding: 0 3mm;
        }
        
        .booking-terms-title {
            font-size: 12pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 3mm;
            text-transform: uppercase;
        }
        
        .booking-terms-list {
            font-size: 9pt;
            line-height: 1.6;
        }
        
        .booking-terms-item {
            padding: 1mm 0;
            padding-left: 5mm;
            text-indent: -3mm;
        }
        
        .booking-terms-item:before {
            content: "• ";
            color: {{ primary_color or '#FF5A00' }};
        }
        
        .booking-terms-bold {
            font-weight: bold;
        }
        
        /* Галерея */
        .gallery {
            margin-top: 8mm;
            page-break-inside: avoid;
        }
        
        .gallery-row {
            display: table;
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 2mm;
            margin-bottom: 2mm;
        }
        
        .gallery-item {
            display: table-cell;
            width: 33.333%;
            vertical-align: top;
        }
        
        .gallery-photo {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 2mm;
        }
        
        /* Футер */
        .footer {
            margin-top: 8mm;
            padding-top: 3mm;
            text-align: center;
            font-size: 9pt;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка (завантажується користувачем) -->
        {% if header_image_src %}
        <img src="{{ header_image_src }}" alt="Header" class="header-image">
        {% endif %}
        
        <!-- Головний заголовок -->
        <div class="main-title">
            <h1>КОМЕРЦІЙНА ПРОПОЗИЦІЯ {{ company_name or 'DZYGA CATERING' }}</h1>
            <div class="manager-info">
                <div class="manager-info-row">
                    <span class="manager-info-cell">Менеджер: {{ kp.coordinator_name or '—' }}</span>
                    <span class="manager-info-cell">Номер: {{ kp.coordinator_phone or '—' }}</span>
                    <span class="manager-info-cell">Пошта: {{ kp.client_email or '—' }}</span>
                </div>
            </div>
        </div>
        
        <!-- Інформація про клієнта -->
        <div class="client-info">
            <div class="client-info-row">
                <div class="client-info-col">
                    <div class="client-info-line"><span class="client-info-label">Заявник:</span> {{ kp.client_name or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Номер телефону:</span> {{ kp.client_phone or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Пошта:</span> {{ kp.client_email or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Формат:</span> {{ kp.event_format or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Місце проведення:</span> {{ kp.event_location or '—' }}</div>
                </div>
                <div class="client-info-col">
                    <div class="client-info-line">Тривалість заходу: <span class="client-info-value">{{ kp.event_time or '—' }}</span></div>
                    <div class="client-info-line">Кількість гостей: <span class="client-info-value">{{ people_count or kp.people_count or '—' }}</span></div>
                    <div class="client-info-line">Вихід г/людина: <span class="client-info-value">{{ weight_per_person or '—' }}</span></div>
                    <div class="client-info-line">Вихід грн/людину: <span class="client-info-value">{% if kp.price_per_person %}{{ "%.0f"|format(kp.price_per_person) }} грн{% else %}—{% endif %}</span></div>
                    <div class="client-info-line">Всього до сплати: <span class="client-info-value" style="color: {{ primary_color or '#FF5A00' }};">{{ grand_total_formatted or '—' }}</span></div>
                </div>
            </div>
        </div>
        
        <!-- МЕНЮ по форматах -->
        {% if formats %}
        {% for fmt in formats %}
        
        <!-- Хедер формату -->
        <div class="section-header">
            {{ fmt.name if fmt.name else "МЕНЮ" }}{% if formats|length > 1 %} {{ loop.index }}{% endif %}
        </div>
        
        <!-- Заголовки таблиці меню -->
        <div class="table-header">
            <div class="table-header-row">
                <div class="table-header-cell name-col">НАЗВА</div>
                <div class="table-header-cell photo-col">ФОТО</div>
                <div class="table-header-cell value-col">вага порції, г</div>
                <div class="table-header-cell value-col">к-сть порцій</div>
                <div class="table-header-cell value-col">ціна, грн</div>
                <div class="table-header-cell value-col">сума, грн</div>
            </div>
        </div>
        
        <!-- Страви по категоріях -->
        {% for section in menu_sections %}
        {% set section_items = fmt['items'] | selectattr('category_name', 'equalto', section) | list %}
        
        {% if section_items %}
        <!-- Категорія -->
        <div style="text-align: center;">
            <div class="category-pill">{{ section }}</div>
        </div>
        
        {% for item in section_items %}
        <div class="item-row">
            <div class="item-row-inner">
                <div class="item-cell name-col">{{ item.name }}</div>
                <div class="item-cell photo-col">
                    {% if item.photo_src %}
                    <img src="{{ item.photo_src }}" class="item-photo" alt="">
                    {% endif %}
                </div>
                <div class="item-cell value-col">{% if item.weight_raw %}{{ "%.0f"|format(item.weight_raw * 1000) }}{% else %}—{% endif %}</div>
                <div class="item-cell value-col">{{ item.quantity }}</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.price_raw) if item.price_raw else '—' }} ₴</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.total_raw) if item.total_raw else '—' }} ₴</div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        {% endfor %}
        
        <!-- Страви без категорії -->
        {% set uncategorized = fmt['items'] | rejectattr('category_name') | list %}
        {% if uncategorized %}
        <div style="text-align: center;">
            <div class="category-pill">ІНШІ СТРАВИ</div>
        </div>
        {% for item in uncategorized %}
        <div class="item-row">
            <div class="item-row-inner">
                <div class="item-cell name-col">{{ item.name }}</div>
                <div class="item-cell photo-col">
                    {% if item.photo_src %}
                    <img src="{{ item.photo_src }}" class="item-photo" alt="">
                    {% endif %}
                </div>
                <div class="item-cell value-col">{% if item.weight_raw %}{{ "%.0f"|format(item.weight_raw * 1000) }}{% else %}—{% endif %}</div>
                <div class="item-cell value-col">{{ item.quantity }}</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.price_raw) if item.price_raw else '—' }} ₴</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.total_raw) if item.total_raw else '—' }} ₴</div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        <!-- Підсумок меню -->
        <div class="summary-gray">
            <div class="summary-gray-line summary-gray-bold">ВСЬОГО ЗА МЕНЮ: {{ fmt.food_total_formatted }}</div>
            {% if fmt.discount_percent and fmt.discount_amount %}
            <div class="summary-gray-line">знижка на меню {{ fmt.discount_percent }}% - {{ fmt.discount_amount_formatted }}</div>
            {% endif %}
            {% if fmt.total_after_discount %}
            <div class="summary-gray-line summary-gray-bold">за меню з урахуванням знижки: {{ fmt.total_after_discount_formatted }}</div>
            {% endif %}
        </div>
        
        {% endfor %}
        {% endif %}
        
        <!-- ОБЛАДНАННЯ -->
        {% if (not template_config or template_config.show_equipment_block) and equipment_total %}
        <div class="section-header">ОБЛАДНАННЯ</div>
        
        <div class="table-header">
            <div class="table-header-row">
                <div class="table-header-cell name-col">НАЗВА</div>
                <div class="table-header-cell value-col">ціна оренди, грн/шт</div>
                <div class="table-header-cell value-col">ціна втрати грн/шт</div>
                <div class="table-header-cell value-col">к-сть, шт</div>
                <div class="table-header-cell value-col">сума, грн</div>
            </div>
        </div>
        
        <!-- TODO: Тут будуть рядки обладнання коли додамо equipment_items -->
        
        <div class="summary-gray">
            <div class="summary-gray-line summary-gray-bold">ДО СПЛАТИ ЗА ОБЛАДНАННЯ: {{ equipment_total }}</div>
        </div>
        {% endif %}
        
        <!-- СЕРВІСНЕ ОБСЛУГОВУВАННЯ -->
        {% if (not template_config or template_config.show_service_block) and service_total %}
        <div class="section-header">СЕРВІСНЕ ОБСЛУГОВУВАННЯ</div>
        
        <div class="table-header">
            <div class="table-header-row">
                <div class="table-header-cell" style="width: 75%; text-align: left;">Позиція</div>
                <div class="table-header-cell" style="width: 25%; text-align: right;">сума</div>
            </div>
        </div>
        
        <!-- TODO: Тут будуть рядки сервісу коли додамо service_items -->
        
        <div class="summary-gray">
            <div class="summary-gray-line summary-gray-bold">ДО СПЛАТИ ЗА СЕРВІС: {{ service_total }}</div>
        </div>
        {% endif %}
        
        <!-- ТРАНСПОРТ -->
        {% if (not template_config or template_config.show_transport_block) and transport_total %}
        <div class="summary-gray" style="margin-top: 3mm;">
            <div class="summary-gray-line summary-gray-bold">ТРАНСПОРТНІ ВИТРАТИ: {{ transport_total }}</div>
        </div>
        {% endif %}
        
        <!-- ФІНАЛЬНИЙ ПІДСУМОК -->
        <div class="final-summary">
            <div class="final-summary-main">ВСЬОГО ДО СПЛАТИ: {{ grand_total_formatted }}</div>
            {% if fop_percent and fop_extra_formatted %}
            <div class="final-summary-fop">оплата на ФОП +{{ fop_percent|round(0)|int }}% {{ grand_total_with_fop_formatted }}</div>
            {% endif %}
        </div>
        
        <!-- УМОВИ БРОНЮВАННЯ -->
        {% if kp.booking_terms %}
        <div class="booking-terms">
            <div class="booking-terms-title">УМОВИ БРОНЮВАННЯ ЗАХОДУ:</div>
            <div class="booking-terms-list">
                {{ kp.booking_terms | replace('\n', '</div><div class="booking-terms-item">') | safe }}
            </div>
        </div>
        {% endif %}
        
        <!-- ГАЛЕРЕЯ ФОТО -->
        {% if gallery_photos and gallery_photos|length > 0 %}
        <div class="gallery">
            {% for row_num in range(0, (gallery_photos|length + 2) // 3) %}
            <div class="gallery-row">
                {% for col_num in range(3) %}
                    {% set photo_index = row_num * 3 + col_num %}
                    {% if photo_index < gallery_photos|length %}
                    <div class="gallery-item">
                        <img src="{{ gallery_photos[photo_index] }}" class="gallery-photo" alt="">
                    </div>
                    {% else %}
                    <div class="gallery-item"></div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Футер -->
        {% if template_config and template_config.footer_text %}
        <div class="footer">
            <p>{{ template_config.footer_text }}</p>
        </div>
        {% endif %}
        
    </div>
</body>
</html>
