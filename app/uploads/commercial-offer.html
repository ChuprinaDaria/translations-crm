<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>{{ kp.title or 'Комерційна пропозиція' }}</title>
    <!-- Google Fonts - розширений набір -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500;600&family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@400;600;700&family=Oswald:wght@400;500;600&family=Lora:wght@400;600;700&family=Raleway:wght@400;500;700&family=PT+Sans:wght@400;700&family=Nunito:wght@400;600;700&family=Source+Sans+3:wght@400;600;700&family=Merriweather:wght@400;700&family=Poppins:wght@400;500;600;700&family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Gilroy шрифт через CDN -->
    <link rel="preconnect" href="https://fonts.cdnfonts.com" crossorigin>
    <link href="https://fonts.cdnfonts.com/css/gilroy" rel="stylesheet">
    <style>
        /* === КОЛЬОРОВА СХЕМА (динамічна з шаблону) === */
        :root {
            --orange-format: {{ format_bg_color or '#FF8C00' }};      /* Фон формату (ФУРШЕТ 13:30-14:30) */
            --orange-categories: {{ category_bg_color or '#FFB84D' }};   /* Фон категорій страв */
            --orange-header: {{ table_header_bg_color or '#FFA500' }};   /* Фон шапки таблиці */
            --orange-text: {{ primary_color or '#FF8C00' }};         /* Для акцентів (ціни) */
            --summary-bg: {{ summary_bg_color or '#F3F4F6' }};       /* Фон "ДО СПЛАТИ ЗА..." */
            --total-bg: {{ total_bg_color or '#FF8C00' }};           /* Фон "ВСЬОГО ДО СПЛАТИ" */
            --text-dark: {{ text_color or '#333333' }};
            --text-gray: #666666;
            --border-light: #E5E5E5;
            --bg-gray: #666666;
            
            /* Шрифти */
            --font-title: {{ title_font or 'Montserrat, Arial, sans-serif' }};
            --font-header: {{ header_font or 'Montserrat, Arial, sans-serif' }};
            --font-body: {{ body_font or 'Inter, Arial, sans-serif' }};
            --font-table: {{ table_font or 'Inter, Arial, sans-serif' }};
        }
        
        @page {
            size: {% if template_config and template_config.page_orientation == 'landscape' %}A4 landscape{% else %}A4{% endif %};
            margin: 10mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* === ШРИФТИ === */
        body {
            font-family: var(--font-body);
            font-weight: 400;
            color: var(--text-dark);
            background-color: #ffffff;
            line-height: 1.4;
            font-size: 10pt;
        }
        
        /* Головний заголовок */
        h1, .main-title h1 {
            font-family: var(--font-title);
            font-weight: 700;
        }
        
        /* Заголовки секцій */
        h2, .format-title, .category-title, .section-header {
            font-family: var(--font-header);
            font-weight: 700;
        }
        
        /* Жирний акцент */
        .header-info strong, .price, .client-info-label {
            font-family: var(--font-body);
            font-weight: 600;
        }
        
        /* Таблиця */
        .table-header, .menu-table, .menu-table td {
            font-family: var(--font-table);
        }
        
        .container {
            max-width: 100%;
        }
        
        /* === ШАПКА - завантажується користувачем === */
        .header-image {
            width: 100%;
            height: auto;
            margin-bottom: 0;
        }
        
        /* === ГОЛОВНИЙ ЗАГОЛОВОК КП === */
        .main-title {
            text-align: center;
            padding: 5mm 0;
        }
        
        .main-title h1 {
            font-family: var(--font-title);
            font-size: 18pt;
            font-weight: 700;
            color: var(--orange-text);
            text-transform: uppercase;
            margin-bottom: 3mm;
            letter-spacing: 0.5px;
        }
        
        .manager-info {
            display: table;
            width: 100%;
            text-align: center;
        }
        
        .manager-info-row {
            display: table-row;
        }
        
        .manager-info-cell {
            display: table-cell;
            color: var(--orange-text);
            font-size: 10pt;
            font-weight: 500;
            padding: 0 5mm;
        }
        
        /* === БЛОК ІНФОРМАЦІЇ ПРО КЛІЄНТА === */
        .client-info {
            display: table;
            width: 100%;
            margin: 5mm 0;
            padding: 3mm 0;
        }
        
        .client-info-row {
            display: table-row;
        }
        
        .client-info-col {
            display: table-cell;
            width: 50%;
            vertical-align: top;
            padding: 0 3mm;
        }
        
        .client-info-line {
            padding: 1.5mm 0;
            font-size: 10pt;
        }
        
        .client-info-label {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .client-info-value {
            font-weight: 600;
        }
        
        /* === БЛОК ФОРМАТУ ЗАХОДУ (ФУРШЕТ 13:30-14:30) === */
        .section-header {
            background: var(--orange-format);
            color: white;
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 16pt;
            font-weight: 700;
            text-align: center;
            padding: 4mm;
            margin-top: 5mm;
            margin-bottom: 4mm;  /* Відступ до шапки таблиці */
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* === ШАПКА ТАБЛИЦІ (НАЗВА, ФОТО, ВАГА...) === */
        .table-header {
            display: table;
            width: 100%;
            background: var(--orange-header);
            color: white;
            font-family: 'Inter', Arial, sans-serif;
            font-size: 9pt;
            font-weight: 600;
            margin-top: 0;
        }
        
        .table-header-row {
            display: table-row;
        }
        
        .table-header-cell {
            display: table-cell;
            padding: 2.5mm 2mm;
            text-align: center;
            vertical-align: middle;
            border-right: 1px solid rgba(255,255,255,0.3);
            text-transform: lowercase;
        }
        
        .table-header-cell:first-child {
            text-transform: uppercase;
        }
        
        .table-header-cell:last-child {
            border-right: none;
        }
        
        .table-header-cell.name-col {
            text-align: left;
            width: 35%;
            padding-left: 3mm;
        }
        
        .table-header-cell.photo-col {
            width: 15%;
        }
        
        .table-header-cell.value-col {
            width: 12.5%;
        }
        
        /* === КАТЕГОРІЯ СТРАВ - НА ВСЮ ШИРИНУ === */
        .category-row {
            width: 100%;
            margin: 5mm 0 3mm 0;
        }
        
        .category-pill {
            background: var(--orange-categories);
            color: white;
            font-family: 'Montserrat', Arial, sans-serif;
            font-weight: 700;
            text-align: center;
            padding: 3mm 0;
            width: 100%;
            border-radius: 15px;
            text-transform: uppercase;
            font-size: 11pt;
            letter-spacing: 0.5px;
        }
        
        /* === РЯДОК СТРАВИ === */
        .item-row {
            display: table;
            width: 100%;
            border-bottom: 1px solid var(--border-light);
        }
        
        .item-row-inner {
            display: table-row;
        }
        
        .item-cell {
            display: table-cell;
            padding: 3mm 2mm;
            vertical-align: middle;
            font-size: 10pt;
        }
        
        .item-cell.name-col {
            width: 35%;
            text-align: left;
            padding-left: 3mm;
        }
        
        .item-cell.photo-col {
            width: 15%;
            text-align: center;
        }
        
        .item-cell.value-col {
            width: 12.5%;
            text-align: center;
        }
        
        .item-photo {
            width: 18mm;
            height: 18mm;
            object-fit: cover;
            border-radius: 2mm;
        }
        
        /* === БЛОК ПІДСУМКІВ (ДО СПЛАТИ ЗА...) === */
        .summary-gray {
            background: var(--summary-bg);
            color: #333333;
            padding: 3mm 5mm;
            margin-top: 2mm;
        }
        
        .summary-gray-line {
            padding: 1mm 0;
            font-size: 10pt;
        }
        
        .summary-gray-bold {
            font-weight: 600;
            font-size: 11pt;
        }
        
        /* === ФІНАЛЬНИЙ ПІДСУМОК === */
        .final-summary {
            background: var(--total-bg);
            color: white;
            padding: 4mm 5mm;
            margin-top: 5mm;
            text-align: center;
        }
        
        .final-summary-main {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 14pt;
            font-weight: 700;
            padding: 2mm 0;
        }
        
        .final-summary-fop {
            font-size: 11pt;
            font-weight: 600;
            padding: 1mm 0;
        }
        
        /* === ТАБЛИЦЯ СЕРВІСУ === */
        .service-row {
            display: table;
            width: 100%;
            border-bottom: 1px solid var(--border-light);
        }
        
        .service-cell {
            display: table-cell;
            padding: 3mm 2mm;
            vertical-align: middle;
            font-size: 10pt;
        }
        
        .service-cell.name-col {
            width: 75%;
            text-align: left;
        }
        
        .service-cell.value-col {
            width: 25%;
            text-align: right;
        }
        
        /* === УМОВИ БРОНЮВАННЯ === */
        .booking-terms {
            margin-top: 8mm;
            padding: 0 3mm;
        }
        
        .booking-terms-title {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 13pt;
            font-weight: 800;
            text-align: center;
            margin-bottom: 4mm;
            text-transform: uppercase;
            color: var(--orange-text);
            letter-spacing: 0.5px;
        }
        
        .booking-terms-list {
            font-size: 9pt;
            line-height: 1.6;
        }
        
        .booking-terms-item {
            padding: 1mm 0;
            padding-left: 5mm;
            text-indent: -3mm;
        }
        
        .booking-terms-item:before {
            content: "• ";
            color: var(--orange-text);
        }
        
        .booking-terms-bold {
            font-weight: 600;
        }
        
        /* === ГАЛЕРЕЯ === */
        .gallery {
            margin-top: 8mm;
            page-break-inside: avoid;
        }
        
        .gallery-row {
            display: table;
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 2mm;
            margin-bottom: 2mm;
        }
        
        .gallery-item {
            display: table-cell;
            width: 33.333%;
            vertical-align: top;
        }
        
        .gallery-photo {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 2mm;
        }
        
        /* === ФУТЕР === */
        .footer {
            margin-top: 8mm;
            padding-top: 3mm;
            text-align: center;
            font-size: 9pt;
            color: var(--text-gray);
        }
        
        /* === ЦІНИ - АКЦЕНТНИЙ КОЛІР === */
        .price-accent {
            color: var(--orange-text);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка (завантажується користувачем) -->
        {% if header_image_src %}
        <img src="{{ header_image_src }}" alt="Header" class="header-image">
        {% endif %}
        
        <!-- Головний заголовок -->
        <div class="main-title">
            <h1>{{ title_text or 'КОМЕРЦІЙНА ПРОПОЗИЦІЯ' }} {{ template_company_name or company_name or 'ДЗИҐА КЕЙТЕРІНҐ' }}</h1>
            <div class="manager-info">
                <div class="manager-info-row">
                    <span class="manager-info-cell">Менеджер: {{ kp.coordinator_name or '—' }}</span>
                    <span class="manager-info-cell">Номер: {{ kp.coordinator_phone or '—' }}</span>
                    <span class="manager-info-cell">Пошта: {{ kp.client_email or '—' }}</span>
                </div>
            </div>
        </div>
        
        <!-- Інформація про клієнта -->
        <div class="client-info">
            <div class="client-info-row">
                <div class="client-info-col">
                    <div class="client-info-line"><span class="client-info-label">Замовник:</span> {{ kp.client_name or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Номер телефону:</span> {{ kp.client_phone or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Пошта:</span> {{ kp.client_email or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Формат:</span> {{ event_format_display or kp.event_format or '—' }}</div>
                    <div class="client-info-line"><span class="client-info-label">Місце проведення:</span> {{ kp.event_location or '—' }}</div>
                </div>
                <div class="client-info-col">
                    <div class="client-info-line">Тривалість заходу: <span class="client-info-value">{{ kp.event_time or '—' }}</span></div>
                    <div class="client-info-line">Кількість гостей: <span class="client-info-value">{{ people_count or kp.people_count or '—' }}</span></div>
                    <div class="client-info-line">Вихід г/людина: <span class="client-info-value">{{ weight_per_person or '—' }} грам</span></div>
                    <div class="client-info-line">Вихід грн/людина: <span class="client-info-value">{% if kp.price_per_person %}{{ "%.0f"|format(kp.price_per_person) }} грн{% else %}—{% endif %}</span></div>
                    <div class="client-info-line">Всього до сплати: <span class="client-info-value price-accent">{{ grand_total_formatted or '—' }}</span></div>
                </div>
            </div>
        </div>
        
        <!-- МЕНЮ по форматах -->
        {% if formats %}
        {% for fmt in formats %}
        
        <!-- Хедер формату (ФУРШЕТ 13:30-14:30) -->
        <div class="section-header">
            {{ fmt.name if fmt.name else "МЕНЮ" }}{% if formats|length > 1 %} {{ loop.index }}{% endif %}
        </div>
        
        <!-- Заголовки таблиці меню -->
        <div class="table-header">
            <div class="table-header-row">
                <div class="table-header-cell name-col">НАЗВА</div>
                <div class="table-header-cell photo-col">ФОТО</div>
                <div class="table-header-cell value-col">вага порції, г</div>
                <div class="table-header-cell value-col">к-сть порцій</div>
                <div class="table-header-cell value-col">ціна, грн</div>
                <div class="table-header-cell value-col">сума, грн</div>
            </div>
        </div>
        
        <!-- Страви по категоріях -->
        {% for section in menu_sections %}
        {% set section_items = fmt['items'] | selectattr('category_name', 'equalto', section) | list %}
        
        {% if section_items %}
        <!-- Категорія - НА ВСЮ ШИРИНУ -->
        <div class="category-row">
            <div class="category-pill">{{ section }}</div>
        </div>
        
        {% for item in section_items %}
        <div class="item-row">
            <div class="item-row-inner">
                <div class="item-cell name-col">{{ item.name }}</div>
                <div class="item-cell photo-col">
                    {% if item.photo_src %}
                    <img src="{{ item.photo_src }}" class="item-photo" alt="">
                    {% endif %}
                </div>
                <div class="item-cell value-col">{% if item.weight_raw %}{{ "%.0f"|format(item.weight_raw * 1000) }}{% else %}—{% endif %}</div>
                <div class="item-cell value-col">{{ item.quantity }}</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.price_raw) if item.price_raw else '—' }} ₴</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.total_raw) if item.total_raw else '—' }} ₴</div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        {% endfor %}
        
        <!-- Страви без категорії -->
        {% set uncategorized = fmt['items'] | rejectattr('category_name') | list %}
        {% if uncategorized %}
        <div class="category-row">
            <div class="category-pill">ІНШІ СТРАВИ</div>
        </div>
        {% for item in uncategorized %}
        <div class="item-row">
            <div class="item-row-inner">
                <div class="item-cell name-col">{{ item.name }}</div>
                <div class="item-cell photo-col">
                    {% if item.photo_src %}
                    <img src="{{ item.photo_src }}" class="item-photo" alt="">
                    {% endif %}
                </div>
                <div class="item-cell value-col">{% if item.weight_raw %}{{ "%.0f"|format(item.weight_raw * 1000) }}{% else %}—{% endif %}</div>
                <div class="item-cell value-col">{{ item.quantity }}</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.price_raw) if item.price_raw else '—' }} ₴</div>
                <div class="item-cell value-col">{{ "%.2f"|format(item.total_raw) if item.total_raw else '—' }} ₴</div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        <!-- Підсумок меню -->
        <div class="summary-gray">
            <div class="summary-gray-line summary-gray-bold">ВСЬОГО ЗА МЕНЮ: {{ fmt.food_total_formatted }}</div>
            {% if fmt.discount_percent and fmt.discount_amount %}
            <div class="summary-gray-line">знижка на меню {{ fmt.discount_percent }}% - {{ fmt.discount_amount_formatted }}</div>
            {% endif %}
            {% if fmt.total_after_discount %}
            <div class="summary-gray-line summary-gray-bold">за меню з урахуванням знижки: {{ fmt.total_after_discount_formatted }}</div>
            {% endif %}
        </div>
        
        {% endfor %}
        {% endif %}
        
        <!-- ОБЛАДНАННЯ -->
        {% if (not template_config or template_config.show_equipment_block) and equipment_total %}
        <div class="section-header">ОБЛАДНАННЯ</div>
        
        <div class="table-header">
            <div class="table-header-row">
                <div class="table-header-cell name-col">НАЗВА</div>
                <div class="table-header-cell value-col">ціна оренди, грн/шт</div>
                <div class="table-header-cell value-col">ціна втрати грн/шт</div>
                <div class="table-header-cell value-col">к-сть, шт</div>
                <div class="table-header-cell value-col">сума, грн</div>
            </div>
        </div>
        
        <!-- Рядки обладнання -->
        {% if equipment_items %}
        {% for eq_item in equipment_items %}
        <div class="item-row">
            <div class="item-row-inner">
                <div class="item-cell name-col">{{ eq_item.name }}</div>
                <div class="item-cell value-col">{{ "%.2f"|format(eq_item.rental_price) if eq_item.rental_price else '—' }} ₴</div>
                <div class="item-cell value-col">{{ "%.2f"|format(eq_item.loss_price) if eq_item.loss_price else '—' }} ₴</div>
                <div class="item-cell value-col">{{ eq_item.quantity }}</div>
                <div class="item-cell value-col">{{ "%.2f"|format(eq_item.total) if eq_item.total else '—' }} ₴</div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        <div class="summary-gray">
            <div class="summary-gray-line summary-gray-bold">ДО СПЛАТИ ЗА ОБЛАДНАННЯ: {{ equipment_total }}</div>
        </div>
        {% endif %}
        
        <!-- СЕРВІСНЕ ОБСЛУГОВУВАННЯ -->
        {% if (not template_config or template_config.show_service_block) and service_total %}
        <div class="section-header">СЕРВІСНЕ ОБСЛУГОВУВАННЯ</div>
        
        <div class="table-header">
            <div class="table-header-row">
                <div class="table-header-cell" style="width: 75%; text-align: left; padding-left: 3mm;">Позиція</div>
                <div class="table-header-cell" style="width: 25%; text-align: right;">сума</div>
            </div>
        </div>
        
        <!-- Рядки сервісу -->
        {% if service_items %}
        {% for srv_item in service_items %}
        <div class="service-row">
            <div class="service-cell name-col">{{ srv_item.name }}</div>
            <div class="service-cell value-col">{{ "%.2f"|format(srv_item.total) if srv_item.total else '—' }} ₴</div>
        </div>
        {% endfor %}
        {% endif %}
        
        <div class="summary-gray">
            <div class="summary-gray-line summary-gray-bold">ДО СПЛАТИ ЗА СЕРВІС: {{ service_total }}</div>
        </div>
        {% endif %}
        
        <!-- ТРАНСПОРТ -->
        {% if (not template_config or template_config.show_transport_block) and transport_total %}
        <div class="summary-gray" style="margin-top: 3mm;">
            <div class="summary-gray-line summary-gray-bold">ТРАНСПОРТНІ ВИТРАТИ: {{ transport_total }}</div>
        </div>
        {% endif %}
        
        <!-- ФІНАЛЬНИЙ ПІДСУМОК -->
        <div class="final-summary">
            <div class="final-summary-main">ВСЬОГО ДО СПЛАТИ: {{ grand_total_formatted }}</div>
            {% if fop_percent and fop_extra_formatted %}
            <div class="final-summary-fop">оплата на ФОП +{{ fop_percent|round(0)|int }}% {{ grand_total_with_fop_formatted }}</div>
            {% endif %}
        </div>
        
        <!-- УМОВИ БРОНЮВАННЯ (з шаблону) -->
        {% if booking_terms %}
        <div class="booking-terms">
            <div class="booking-terms-title">УМОВИ БРОНЮВАННЯ ЗАХОДУ:</div>
            <div class="booking-terms-list">
                {% for line in booking_terms.split('\n') %}
                {% if line.strip() %}
                <div class="booking-terms-item">{{ line.strip() }}</div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- ГАЛЕРЕЯ ФОТО -->
        {% if gallery_photos and gallery_photos|length > 0 %}
        <div class="gallery">
            {% for row_num in range(0, (gallery_photos|length + 2) // 3) %}
            <div class="gallery-row">
                {% for col_num in range(3) %}
                    {% set photo_index = row_num * 3 + col_num %}
                    {% if photo_index < gallery_photos|length %}
                    <div class="gallery-item">
                        <img src="{{ gallery_photos[photo_index] }}" class="gallery-photo" alt="">
                    </div>
                    {% else %}
                    <div class="gallery-item"></div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Футер -->
        {% if template_config and template_config.footer_text %}
        <div class="footer">
            <p>{{ template_config.footer_text }}</p>
        </div>
        {% endif %}
        
    </div>
</body>
</html>
