# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ - 22 —Å—ñ—á–Ω—è 2026

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ1: Telegram —Å–µ—Å—ñ—è –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è (–í–ò–ü–†–ê–í–õ–ï–ù–û)

### –ü—Ä–æ–±–ª–µ–º–∞
```
sqlalchemy.exc.ProgrammingError: column "api_id" is of type uuid but expression is of type integer
```

–ö–æ–ª–æ–Ω–∫–∞ `api_id` –≤ —Ç–∞–±–ª–∏—Ü—ñ `telegram_accounts` –º–∞–ª–∞ —Ç–∏–ø UUID, –∞–ª–µ Telegram API ID - —Ü–µ integer (28906808).

### –†—ñ—à–µ–Ω–Ω—è
1. ‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—è `fix_telegram_accounts_api_id_type.sql` –≤–∂–µ —ñ—Å–Ω—É—î —ñ –≤–∏–ø—Ä–∞–≤–ª—è—î —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏
2. ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Å–∫—Ä–∏–ø—Ç `run_fix_migration.sh` –¥–ª—è –∑–∞–ø—É—Å–∫—É –º—ñ–≥—Ä–∞—Ü—ñ—ó

### –Ø–∫ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏:
```bash
# –í–∞—Ä—ñ–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
cd "/home/dchuprina/crm translation/translations-crm"
./run_fix_migration.sh

# –í–∞—Ä—ñ–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ docker exec
docker exec crm_translations_backend python run_migration.py

# –í–∞—Ä—ñ–∞–Ω—Ç 3: –ü—Ä—è–º–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ë–î
docker exec -it crm_translations_postgres psql -U translator -d crm_db -f /path/to/fix_telegram_accounts_api_id_type.sql
```

–ü—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ—ó –º–æ–∂–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–≥—Ç–∏ Telegram –∞–∫–∞—É–Ω—Ç –∑–Ω–æ–≤—É.

---

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ2: WebSocket –ª–æ–≥—É–≤–∞–Ω–Ω—è (–í–ò–ü–†–ê–í–õ–ï–ù–û)

### –ü—Ä–æ–±–ª–µ–º–∞
WebSocket –ø—ñ–¥–∫–ª—é—á–∞–≤—Å—è —ñ –≤—ñ–¥–∫–ª—é—á–∞–≤—Å—è, –∞–ª–µ –Ω–µ –±—É–ª–æ –≤–∏–¥–Ω–æ —â–æ —Å–∞–º–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –∑'—î–¥–Ω–∞–Ω–Ω—è.

### –†—ñ—à–µ–Ω–Ω—è
–î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ –æ–±–æ—Ö WebSocket endpoints:

1. **`/api/v1/communications/ws/{user_id}`** (main.py):
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö: `logger.info(f"WebSocket received from user {user_id}: {data}")`
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö: `logger.info(f"WebSocket sent welcome message...")`
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è ping/pong: `logger.info(f"WebSocket sent pong to user {user_id}")`

2. **`/api/v1/notifications/ws/{user_id}`** (notifications/router.py):
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è ping/pong –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π

3. **MessagesConnectionManager** (communications/router.py):
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å: `logger.info(f"WebSocket sending message to user {user_id}: {message}")`
   - ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤:
```bash
# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å WebSocket –ª–æ–≥–∏
docker logs crm_translations_backend | grep -i websocket

# –ê–±–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
docker logs -f crm_translations_backend | grep -i websocket
```

---

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ3: Email —Å–µ—Ä–≤—ñ—Å –ª–æ–≥—É–≤–∞–Ω–Ω—è (–ü–û–ö–†–ê–©–ï–ù–û)

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ–≤—ñ–¥–æ–º–æ —á–∏ –ø—Ä–∞—Ü—é—î email —Å–µ—Ä–≤—ñ—Å, –Ω–µ –±—É–ª–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ª–æ–≥—ñ–≤.

### –†—ñ—à–µ–Ω–Ω—è
–î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ `email_imap_listener.py`:

1. ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞: `logger.info(f"Processing account: {email}")`
2. ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö email: `logger.info(f"Found {len(emails)} new emails")`
3. ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è IMAP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:
   - `logger.info(f"Connecting to IMAP {host}:{port}")`
   - `logger.info(f"IMAP SSL connection established")`
   - `logger.info(f"IMAP login successful")`
   - `logger.info(f"IMAP inbox selected")`
   - `logger.info(f"IMAP connection closed")`
4. ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –∑ `exc_info=True`

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ email —Å–µ—Ä–≤—ñ—Å—É:
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π email listener
docker ps | grep email_imap_listener

# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å –ª–æ–≥–∏ email —Å–µ—Ä–≤—ñ—Å—É
docker logs crm_translations_email_listener

# –ê–±–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
docker logs -f crm_translations_email_listener
```

### –Ø–∫—â–æ email listener –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —á–µ—Ä–µ–∑ docker-compose
docker-compose up -d email_imap_listener

# –ê–±–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏
docker-compose restart
```

---

## üìã –ü–ª–∞–Ω –¥—ñ–π –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 1. –í–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ç–∏–ø api_id (5 —Ö–≤)
```bash
cd "/home/dchuprina/crm translation/translations-crm"
./run_fix_migration.sh
```

### 2. –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è Telegram —Å–µ—Å—ñ—ó (10 —Ö–≤)
- –í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí Telegram
- –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π Telegram –∞–∫–∞—É–Ω—Ç –∑:
  - Name: "Daria"
  - Phone: "+380731295110"
  - Session String: (–≤–∞—à session string)
  - API ID: 28906808
  - API Hash: "db1b1c571ac4b33152da9c53d0e2d08c"
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ WebSocket –ª–æ–≥–∏ (5 —Ö–≤)
```bash
# –í—ñ–¥–∫—Ä–∏—Ç–∏ inbox –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å –ª–æ–≥–∏
docker logs -f crm_translations_backend | grep -i websocket
```

–ú–∞—î –±—É—Ç–∏ –≤–∏–¥–Ω–æ:
- `WebSocket connection attempt from user: ...`
- `WebSocket accepted for user: ...`
- `WebSocket sent welcome message...`
- `WebSocket received from user: ping`
- `WebSocket sent pong to user: ...`

### 4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ email —Å–µ—Ä–≤—ñ—Å (15 —Ö–≤)
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π
docker ps | grep email

# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å –ª–æ–≥–∏
docker logs crm_translations_email_listener

# –ú–∞—î –±—É—Ç–∏ –≤–∏–¥–Ω–æ:
# - "Starting Email IMAP Listener..."
# - "Checking X manager SMTP accounts..."
# - "Connecting to IMAP ..."
# - "Found X unread emails..."
```

### 5. –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤ –∑ Telegram (20 —Ö–≤)
- –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—å —â–æ `telegram_listener.py` –∑–∞–ø—É—â–µ–Ω–∏–π
- –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ Telegram –∞–∫–∞—É–Ω—Ç
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –≤–æ–Ω–æ –∑'—è–≤–∏–ª–æ—Å—å –≤ inbox
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ WebSocket —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ –ª–æ–≥–∞—Ö

---

## üîç –î–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏ api_id:
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'telegram_accounts' 
AND column_name = 'api_id';
```

–ú–∞—î –±—É—Ç–∏: `data_type = 'integer'`

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ Telegram –∞–∫–∞—É–Ω—Ç–∏:
```sql
SELECT id, name, phone, is_active, api_id, api_hash 
FROM telegram_accounts;
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ SMTP –∞–∫–∞—É–Ω—Ç–∏:
```sql
SELECT id, email, is_active, smtp_host, imap_host 
FROM manager_smtp_accounts 
WHERE is_active = true;
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è:
```bash
# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å –∞–∫—Ç–∏–≤–Ω—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è –≤ –ª–æ–≥–∞—Ö
docker logs crm_translations_backend | grep "WebSocket connected"
```

---

## üìù –§–∞–π–ª–∏ —â–æ –±—É–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ

1. ‚úÖ `backend/main.py` - –¥–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ WebSocket endpoint
2. ‚úÖ `backend/modules/notifications/router.py` - –¥–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ WebSocket endpoint
3. ‚úÖ `backend/modules/communications/router.py` - –¥–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ MessagesConnectionManager
4. ‚úÖ `backend/email_imap_listener.py` - –ø–æ–∫—Ä–∞—â–µ–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è IMAP –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
5. ‚úÖ `run_fix_migration.sh` - —Å—Ç–≤–æ—Ä–µ–Ω–æ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫—É –º—ñ–≥—Ä–∞—Ü—ñ—ó

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ

1. **–ú—ñ–≥—Ä–∞—Ü—ñ—é —Ç—Ä–µ–±–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –û–î–†–ê–ó–£** - –±–µ–∑ –Ω–µ—ó Telegram –∞–∫–∞—É–Ω—Ç–∏ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è
2. **Email listener –º–∞—î –±—É—Ç–∏ –∑–∞–ø—É—â–µ–Ω–∏–π** - –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ `docker-compose.yml` —â–æ —Å–µ—Ä–≤—ñ—Å `email_imap_listener` –≤–∫–ª—é—á–µ–Ω–∏–π
3. **Telegram listener –º–∞—î –±—É—Ç–∏ –∑–∞–ø—É—â–µ–Ω–∏–π –æ–∫—Ä–µ–º–æ** - —Ü–µ –Ω–µ docker —Å–µ—Ä–≤—ñ—Å, —Ç—Ä–µ–±–∞ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –≤—Ä—É—á–Ω—É –∞–±–æ —á–µ—Ä–µ–∑ systemd

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—Å—ñ—Ö –∫—Ä–æ–∫—ñ–≤:
- ‚úÖ Telegram —Å–µ—Å—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- ‚úÖ WebSocket –ø–µ—Ä–µ–¥–∞—î –¥–∞–Ω—ñ –∑ –¥–µ—Ç–∞–ª—å–Ω–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º
- ‚úÖ Email —Å–µ—Ä–≤—ñ—Å –º–∞—î –ø–æ–≤–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –í—Å—ñ –ø–æ–º–∏–ª–∫–∏ –ª–µ–≥–∫–æ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ —á–µ—Ä–µ–∑ –ª–æ–≥–∏

