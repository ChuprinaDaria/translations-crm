name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ´ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ”Ğ¼
  check:
    name: Check Frontend & Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install frontend dependencies
      run: npm ci
    
    - name: TypeScript type check
      run: |
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit
        else
          echo "âš ï¸ No tsconfig.json found, skipping TypeScript check"
        fi
    
    - name: Build frontend
      run: npm run build
    
    - name: Verify frontend build
      run: |
        if [ ! -d "build" ]; then
          echo "âŒ Error: Build directory not found!"
          exit 1
        fi
        if ! grep -r "MenuManagement" build/assets/ > /dev/null 2>&1; then
          echo "âš ï¸ Warning: MenuManagement not found in build"
        fi
        echo "âœ… Frontend build verified!"
    
    - name: Check backend files
      run: |
        if [ ! -f "app/main.py" ]; then
          echo "âŒ Error: Backend main.py not found!"
          exit 1
        fi
        if [ ! -f "app/requirements.txt" ]; then
          echo "âŒ Error: Backend requirements.txt not found!"
          exit 1
        fi
        echo "âœ… Backend files verified!"

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
  deploy:
    name: Deploy to Server
    needs: check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      env:
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        APP_ENV: ${{ secrets.APP_ENV }}
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,JWT_SECRET,APP_ENV
        script: |
          set -e
          cd /opt/cafe-crm
          
          echo "ğŸ“¥ Pulling latest code..."
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ remote Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° SSH, ÑĞºÑ‰Ğ¾ Ğ½Ñ– - Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾
          REMOTE_URL=$(git config --get remote.origin.url)
          if [[ "$REMOTE_URL" == https://github.com/* ]]; then
            echo "ğŸ”§ Switching remote to SSH..."
            git remote set-url origin git@github.com:Lazysoft-pl/cafe.git
          fi
          # Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ fetch + reset Ğ´Ğ»Ñ ÑƒĞ½Ğ¸ĞºĞ½ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ğ· Ğ°Ğ²Ñ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ñ–ĞºĞ°Ñ†Ñ–Ñ”Ñ
          git fetch origin main
          git reset --hard origin/main
          
          echo "ğŸ“ Creating .env file from secrets..."
          cat > .env << ENVFILE
          JWT_SECRET=${JWT_SECRET}
          POSTGRES_USER=${POSTGRES_USER:-postgres}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
          POSTGRES_DB=${POSTGRES_DB:-cafe_db}
          APP_ENV=${APP_ENV:-production}
          ENVFILE
          
          echo "ğŸ³ Rebuilding backend..."
          docker-compose build backend
          
          echo "â–¶ï¸ Restarting services..."
          docker-compose up -d
          
          echo "â³ Waiting for backend to be healthy..."
          sleep 10
          
          echo "ğŸ” Checking backend health..."
          if docker ps | grep -q cafe_backend; then
            echo "âœ… Backend container is running"
          else
            echo "âŒ Backend container is not running!"
            docker ps -a | grep cafe
            exit 1
          fi
          
          echo "ğŸ”¨ Building frontend..."
          rm -rf build/
          NODE_OPTIONS=--max_old_space_size=1536 npm run build
          
          echo "âœ… Checking build..."
          if grep -r "MenuManagement" build/assets/ > /dev/null; then
            echo "âœ… Frontend build complete!"
          else
            echo "âš ï¸ Frontend build might be incomplete"
          fi
          
          echo "ğŸ”„ Restarting nginx..."
          sudo docker restart whiteout_nginx
          
          echo "ğŸ‰ Deploy finished at $(date)"
          echo "ğŸ“Š Running containers:"
          docker ps --filter "name=cafe" --format "table {{.Names}}\t{{.Status}}"
