name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ´ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ”Ğ¼
  check:
    name: Check Frontend & Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install frontend dependencies
      run: npm ci
    
    - name: TypeScript type check
      run: |
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit
        else
          echo "âš ï¸ No tsconfig.json found, skipping TypeScript check"
        fi
    
    - name: Build frontend
      run: npm run build
    
    - name: Verify frontend build
      run: |
        if [ ! -d "build" ]; then
          echo "âŒ Error: Build directory not found!"
          exit 1
        fi
        if ! grep -r "MenuManagement" build/assets/ > /dev/null 2>&1; then
          echo "âš ï¸ Warning: MenuManagement not found in build"
        fi
        echo "âœ… Frontend build verified!"
    
    - name: Check backend files
      run: |
        if [ ! -f "app/main.py" ]; then
          echo "âŒ Error: Backend main.py not found!"
          exit 1
        fi
        if [ ! -f "app/requirements.txt" ]; then
          echo "âŒ Error: Backend requirements.txt not found!"
          exit 1
        fi
        echo "âœ… Backend files verified!"

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
  deploy:
    name: Deploy to Server
    needs: check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      env:
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        APP_ENV: ${{ secrets.APP_ENV }}
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,JWT_SECRET,APP_ENV
        script: |
          set -e
          cd /opt/cafe-crm
          
          echo "ğŸ“¥ Pulling latest code..."
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ´Ğ»Ñ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ SSH Ğ· deploy key
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ GitHub Ğ´Ğ¾ known_hosts
          if ! grep -q "github.com" ~/.ssh/known_hosts 2>/dev/null; then
            echo "ğŸ”§ Adding GitHub to known_hosts..."
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            chmod 600 ~/.ssh/known_hosts
          fi
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ– Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ remote Ğ½Ğ° SSH ÑĞºÑ‰Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾
          REMOTE_URL=$(git config --get remote.origin.url || echo "")
          if [[ -z "$REMOTE_URL" ]]; then
            echo "âš ï¸ No remote URL found"
            exit 1
          elif [[ "$REMOTE_URL" == https://github.com/* ]]; then
            echo "ğŸ”§ Switching remote from HTTPS to SSH..."
            git remote set-url origin git@github.com:Lazysoft-pl/cafe.git
          elif [[ "$REMOTE_URL" == git@github.com:* ]]; then
            echo "âœ… Remote already configured for SSH"
          else
            echo "â„¹ï¸ Using existing remote: $REMOTE_URL"
          fi
          
          # Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ fetch + reset
          echo "ğŸ“¥ Fetching latest changes..."
          git fetch origin main || {
            echo "âŒ Git fetch failed!"
            echo "ğŸ“‹ Current remote configuration:"
            git remote -v
            echo "ğŸ” Checking SSH connection to GitHub..."
            ssh -T git@github.com 2>&1 | head -1 || echo "âš ï¸ SSH test failed"
            exit 1
          }
          git reset --hard origin/main
          echo "âœ… Code updated successfully"
          
          echo "ğŸ“ Creating .env file from secrets..."
          cat > .env << ENVFILE
          JWT_SECRET=${JWT_SECRET}
          POSTGRES_USER=${POSTGRES_USER:-postgres}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
          POSTGRES_DB=${POSTGRES_DB:-cafe_db}
          APP_ENV=${APP_ENV:-production}
          ENVFILE
          
          echo "ğŸ³ Rebuilding backend..."
          # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ ÑĞºÑƒ Ğ²ĞµÑ€ÑÑ–Ñ compose Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ (v2 Ğ°Ğ±Ğ¾ v1)
          if docker compose version > /dev/null 2>&1; then
            COMPOSE_CMD="docker compose"
            echo "âœ… Using Docker Compose V2"
          else
            COMPOSE_CMD="docker-compose"
            echo "â„¹ï¸ Using Docker Compose V1 (legacy)"
          fi
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ buildx, ÑĞºÑ‰Ğ¾ Ğ½Ñ– - Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ°Ğ±Ğ¾ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ fallback
          if ! docker buildx version > /dev/null 2>&1; then
            echo "âš ï¸ Buildx not found, attempting to install..."
            if command -v apt-get > /dev/null 2>&1; then
              sudo apt-get update -qq && sudo apt-get install -y docker-buildx-plugin || echo "âš ï¸ Could not install buildx, using legacy builder"
            fi
          fi
          
          # Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ BuildKit ÑĞºÑ‰Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹
          if docker buildx version > /dev/null 2>&1; then
            echo "âœ… Using BuildKit with buildx"
            export DOCKER_BUILDKIT=1
            COMPOSE_DOCKER_CLI_BUILD=1 $COMPOSE_CMD build backend
          else
            echo "â„¹ï¸ Using legacy Docker builder"
            $COMPOSE_CMD build backend
          fi
          
          echo "â–¶ï¸ Restarting services..."
          $COMPOSE_CMD up -d
          
          echo "â³ Waiting for backend to be healthy..."
          sleep 10
          
          echo "ğŸ” Checking backend health..."
          # Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ñƒ ÑĞ°Ğ¼Ñƒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ compose Ñ‰Ğ¾ Ñ– Ñ€Ğ°Ğ½Ñ–ÑˆĞµ
          if [ -z "$COMPOSE_CMD" ]; then
            if docker compose version > /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
          fi
          
          if docker ps | grep -q cafe_backend; then
            echo "âœ… Backend container is running"
          else
            echo "âŒ Backend container is not running!"
            docker ps -a | grep cafe
            echo "ğŸ“‹ Checking service status..."
            $COMPOSE_CMD ps || true
            exit 1
          fi
          
          echo "ğŸ”¨ Building frontend..."
          rm -rf build/
          # Ğ—Ğ±Ñ–Ğ»ÑŒÑˆÑƒÑ”Ğ¼Ğ¾ heap size Ğ´Ğ»Ñ Ğ²Ğ°Ğ¶ĞºĞ¸Ñ… React/Vite Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ–Ğ²
          NODE_OPTIONS=--max_old_space_size=4096 npm run build
          
          echo "âœ… Checking build..."
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‰Ğ¾ build Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ Ñ–ÑĞ½ÑƒÑ” Ñ– Ğ½Ğµ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ
          if [ ! -d "build" ] || [ -z "$(ls -A build 2>/dev/null)" ]; then
            echo "âŒ Error: Build directory is empty or missing!"
            exit 1
          fi
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¾Ğ²Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²
          if [ ! -f "build/index.html" ]; then
            echo "âŒ Error: index.html not found in build!"
            exit 1
          fi
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ assets
          if [ ! -d "build/assets" ] || [ -z "$(ls -A build/assets 2>/dev/null)" ]; then
            echo "âŒ Error: No assets found in build!"
            exit 1
          fi
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ MenuManagement (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ° Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°)
          if grep -r "MenuManagement" build/assets/ > /dev/null 2>&1; then
            echo "âœ… Frontend build complete and verified!"
          else
            echo "âš ï¸ Warning: MenuManagement not found in build (might be minified)"
            echo "â„¹ï¸ Build directory structure:"
            ls -la build/ || true
          fi
          
          echo "ğŸ”„ Restarting nginx..."
          sudo docker restart whiteout_nginx
          
          echo "ğŸ‰ Deploy finished at $(date)"
          echo "ğŸ“Š Running containers:"
          docker ps --filter "name=cafe" --format "table {{.Names}}\t{{.Status}}"
