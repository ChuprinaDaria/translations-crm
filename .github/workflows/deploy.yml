name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      env:
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        APP_ENV: ${{ secrets.APP_ENV }}
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,JWT_SECRET,APP_ENV
        script: |
          set -e
          cd /opt/cafe-crm
          
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "ğŸ“ Creating .env file from secrets..."
          cat > .env << ENVFILE
          JWT_SECRET=${JWT_SECRET}
          POSTGRES_USER=${POSTGRES_USER:-postgres}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
          POSTGRES_DB=${POSTGRES_DB:-cafe_db}
          APP_ENV=${APP_ENV:-production}
          ENVFILE
          
          echo "ğŸ³ Rebuilding backend..."
          docker-compose build backend
          
          echo "â–¶ï¸ Restarting services..."
          docker-compose up -d
          
          echo "â³ Waiting for backend to be healthy..."
          sleep 10
          
          echo "ğŸ”¨ Building frontend..."
          rm -rf build/
          NODE_OPTIONS=--max_old_space_size=1536 npm run build
          
          echo "âœ… Checking build..."
          if grep -r "MenuManagement" build/assets/ > /dev/null; then
            echo "âœ… Frontend build complete!"
          else
            echo "âš ï¸ Frontend build might be incomplete"
          fi
          
          echo "ğŸ”„ Restarting nginx..."
          sudo docker restart whiteout_nginx
          
          echo "ğŸ‰ Deploy finished at $(date)"
          echo "ğŸ“Š Running containers:"
          docker ps --filter "name=cafe" --format "table {{.Names}}\t{{.Status}}"
