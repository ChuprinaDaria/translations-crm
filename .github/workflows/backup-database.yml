name: Monthly Database Backup

on:
  schedule:
    # Запускається 1 числа кожного місяця о 2:00 UTC
    - cron: '0 2 1 * *'
  workflow_dispatch: # Дозволяє запускати вручну

jobs:
  backup-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup directory
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /opt/translations/backups"

      - name: Backup PostgreSQL database
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} bash << 'BACKUP_SCRIPT'
            set -e
            
            BACKUP_DIR="/opt/translations/backups"
            mkdir -p $BACKUP_DIR
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/crm_db_backup_$TIMESTAMP.sql"
            
            # Отримуємо дані з .env файлу
            DEPLOY_DIR="/opt/translations"
            if [ ! -f "$DEPLOY_DIR/.env" ]; then
              echo "Error: .env file not found at $DEPLOY_DIR/.env"
              exit 1
            fi
            
            source $DEPLOY_DIR/.env
            
            # Перевіряємо що контейнер запущений
            if ! docker ps | grep -q crm_translations_postgres; then
              echo "Error: PostgreSQL container is not running!"
              exit 1
            fi
            
            # Створюємо бекап через docker exec
            echo "Creating database backup..."
            docker exec crm_translations_postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB > $BACKUP_FILE
            
            # Перевіряємо що бекап створено
            if [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
              echo "Error: Backup file is empty or not created!"
              exit 1
            fi
            
            # Стискаємо бекап
            echo "Compressing backup..."
            gzip $BACKUP_FILE
            BACKUP_FILE_GZ="$BACKUP_FILE.gz"
            
            echo "Backup created: $BACKUP_FILE_GZ"
            
            # Видаляємо старі бекапи (залишаємо тільки останній)
            echo "Removing old backups..."
            cd $BACKUP_DIR
            if ls crm_db_backup_*.sql.gz 1> /dev/null 2>&1; then
              # Сортуємо за часом модифікації, залишаємо тільки найновіший
              ls -t crm_db_backup_*.sql.gz | tail -n +2 | xargs -r rm -f
              echo "Old backups removed, keeping only the latest backup"
            else
              echo "No old backups to remove"
            fi
            
            # Показуємо розмір бекапу
            echo "Backup details:"
            ls -lh $BACKUP_FILE_GZ
            du -h $BACKUP_FILE_GZ
          BACKUP_SCRIPT

      - name: Verify backup
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} bash << 'VERIFY_SCRIPT'
            BACKUP_DIR="/opt/translations/backups"
            LATEST_BACKUP=$(ls -t $BACKUP_DIR/crm_db_backup_*.sql.gz 2>/dev/null | head -1)
            
            if [ -z "$LATEST_BACKUP" ]; then
              echo "Error: No backup file found!"
              exit 1
            fi
            
            BACKUP_SIZE=$(du -h "$LATEST_BACKUP" | cut -f1)
            echo "Latest backup: $LATEST_BACKUP"
            echo "Backup size: $BACKUP_SIZE"
            echo "Backup verification: OK"
          VERIFY_SCRIPT

