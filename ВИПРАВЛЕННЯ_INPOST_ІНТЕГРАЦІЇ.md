# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è InPost —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó - –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ finance.shipments

## üî¥ –ü—Ä–æ–±–ª–µ–º–∏ –≤–∏—è–≤–ª–µ–Ω—ñ:

1. **–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ InPost –ø–æ—Å–∏–ª–∫–∏** - —Å—Ç–≤–æ—Ä—é–≤–∞–≤—Å—è –∑–∞–ø–∏—Å —Ç—ñ–ª—å–∫–∏ –≤ `inpost_shipments`, –∞–ª–µ **–ù–ï** –≤ `finance_shipments`
2. **–ü—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ webhook** - –æ–Ω–æ–≤–ª—é–≤–∞–≤—Å—è —Ç—ñ–ª—å–∫–∏ `inpost_shipments`, –∞–ª–µ **–ù–ï** `finance_shipments`
3. **–°—Ç–∞—Ç—É—Å–∏ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞–ª–∏—Å—è** –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤ –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–í—ñ–¥–ø—Ä–∞–≤–∫–∏"

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:

### 1. –î–æ–¥–∞–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –ø–æ—Å–∏–ª–∫–∏

**–§–∞–π–ª:** `backend/modules/postal_services/service.py`

**–ú–µ—Ç–æ–¥:** `create_shipment()`

–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è InPost –ø–æ—Å–∏–ª–∫–∏ —Ç–µ–ø–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞–ø–∏—Å –≤ `finance_shipments` –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º –º–∞–ø–ø—ñ–Ω–≥–æ–º –º–µ—Ç–æ–¥—ñ–≤ —Ç–∞ —Å—Ç–∞—Ç—É—Å—ñ–≤
- –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –≤—Å—ñ –¥–∞–Ω—ñ: tracking_number, tracking_url, —Å—Ç–∞—Ç—É—Å, –∞–¥—Ä–µ—Å–∞, –∫–æ–Ω—Ç–∞–∫—Ç–∏

### 2. –î–æ–¥–∞–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ webhook

**–ú–µ—Ç–æ–¥:** `handle_webhook()`

–ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ webhook –≤—ñ–¥ InPost —Ç–µ–ø–µ—Ä:
- –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è `inpost_shipments` (—è–∫ —Ä–∞–Ω—ñ—à–µ)
- **–ê–í–¢–û–ú–ê–¢–ò–ß–ù–û** –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –∑–∞–ø–∏—Å –≤ `finance_shipments`

### 3. –î–æ–¥–∞–Ω–æ –º–µ—Ç–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

**–ù–æ–≤–∏–π –º–µ—Ç–æ–¥:** `_sync_to_finance_shipment()`

–¶–µ–π –º–µ—Ç–æ–¥:
- –ú–∞–ø–∏—Ç—å `delivery_type` ‚Üí `ShipmentMethod` (parcel_locker ‚Üí INPOST_LOCKER, courier ‚Üí INPOST_COURIER)
- –ú–∞–ø–∏—Ç—å `ShipmentStatus` (InPost) ‚Üí `ShipmentStatus` (Finance):
  - `CREATED` ‚Üí `CREATED`
  - `CONFIRMED` ‚Üí `LABEL_PRINTED`
  - `DISPATCHED_BY_SENDER` ‚Üí `IN_TRANSIT`
  - `READY_TO_PICKUP` ‚Üí `READY_FOR_PICKUP`
  - `DELIVERED` ‚Üí `DELIVERED`
  - `RETURNED_TO_SENDER` ‚Üí `RETURNED`
- –°—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å –∞–±–æ –æ–Ω–æ–≤–ª—é—î —ñ—Å–Ω—É—é—á–∏–π –≤ `finance_shipments`
- –û–Ω–æ–≤–ª—é—î timestamps (shipped_at, delivered_at) –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Å—Ç–∞—Ç—É—Å—É

## üìã –ú–∞–ø–ø—ñ–Ω–≥ —Å—Ç–∞—Ç—É—Å—ñ–≤:

| InPost Status | Finance Status | –û–ø–∏—Å |
|---------------|----------------|------|
| `CREATED` | `CREATED` | –°—Ç–≤–æ—Ä–µ–Ω–æ |
| `CONFIRMED` | `LABEL_PRINTED` | –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ, –µ—Ç–∏–∫–µ—Ç–∫–∞ –≥–æ—Ç–æ–≤–∞ |
| `DISPATCHED_BY_SENDER` | `IN_TRANSIT` | –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –≤ –¥–æ—Ä–æ–∑—ñ |
| `COLLECTED_FROM_SENDER` | `IN_TRANSIT` | –ó–∞–±—Ä–∞–Ω–æ, –≤ –¥–æ—Ä–æ–∑—ñ |
| `TAKEN_BY_COURIER` | `IN_TRANSIT` | –í–∑—è—Ç–æ –∫—É—Ä'—î—Ä–æ–º |
| `READY_TO_PICKUP` | `READY_FOR_PICKUP` | –ì–æ—Ç–æ–≤–æ –¥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è |
| `OUT_FOR_DELIVERY` | `IN_TRANSIT` | –î–æ—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è |
| `DELIVERED` | `DELIVERED` | –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ |
| `RETURNED_TO_SENDER` | `RETURNED` | –ü–æ–≤–µ—Ä–Ω–µ–Ω–æ |
| `CANCELED` | `RETURNED` | –°–∫–∞—Å–æ–≤–∞–Ω–æ |

## üîÑ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∫–∏ —á–µ—Ä–µ–∑ UI

1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î "–í–∏—Å–ª–∞—Ç–∏ —Ç—Ä–µ–∫—ñ–Ω–≥" –≤ —á–∞—Ç—ñ
2. –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `handleTrackingClick()` ‚Üí `settingsApi.createShipment()`
3. Backend —Å—Ç–≤–æ—Ä—é—î –∑–∞–ø–∏—Å –≤ `inpost_shipments`
4. –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è InPost API –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∫–∏
5. **–ù–û–í–û:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞–ø–∏—Å –≤ `finance_shipments`
6. –ü–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è tracking_number —Ç–∞ tracking_url
7. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è draft –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ –∑ —Ç—Ä–µ–∫—ñ–Ω–≥–æ–º
8. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ webhook

1. InPost –Ω–∞–¥—Å–∏–ª–∞—î webhook –ø—Ä–æ –∑–º—ñ–Ω—É —Å—Ç–∞—Ç—É—Å—É
2. Backend –æ–±—Ä–æ–±–ª—è—î webhook –≤ `handle_webhook()`
3. –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∑–∞–ø–∏—Å –≤ `inpost_shipments`
4. **–ù–û–í–û:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –∑–∞–ø–∏—Å –≤ `finance_shipments`
5. –°—Ç–∞—Ç—É—Å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:

‚úÖ –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ InPost –ø–æ—Å–∏–ª–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞–ø–∏—Å –≤ `finance_shipments`  
‚úÖ –ü—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ webhook –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è `finance_shipments`  
‚úÖ –°—Ç–∞—Ç—É—Å–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤ –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–í—ñ–¥–ø—Ä–∞–≤–∫–∏"  
‚úÖ –í—Å—ñ –¥–∞–Ω—ñ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ –º—ñ–∂ –¥–≤–æ–º–∞ —Ç–∞–±–ª–∏—Ü—è–º–∏  

## üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É:

```sql
-- –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è InPost –ø–æ—Å–∏–ª–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
SELECT 
  i.id as inpost_id,
  i.tracking_number,
  i.status as inpost_status,
  f.id as finance_id,
  f.tracking_number as finance_tracking,
  f.status as finance_status,
  f.inpost_shipment_id
FROM inpost_shipments i
LEFT JOIN finance_shipments f ON f.inpost_shipment_id = i.shipment_id
WHERE i.order_id = 'YOUR_ORDER_ID';
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ webhook:

```bash
# –î–∏–≤—ñ—Ç—å—Å—è –ª–æ–≥–∏ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ webhook:
docker-compose logs -f backend | grep -i "synced.*finance"
```

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ:

1. **–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –Ω–µ –±–ª–æ–∫—É—î –æ—Å–Ω–æ–≤–Ω—É –æ–ø–µ—Ä–∞—Ü—ñ—é** - —è–∫—â–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ finance.shipments –Ω–µ –≤–¥–∞–ª–∞—Å—è, –æ—Å–Ω–æ–≤–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –≤—Å–µ –æ–¥–Ω–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è
2. **–ü–æ–º–∏–ª–∫–∏ –ª–æ–≥—É—é—Ç—å—Å—è** - –≤—Å—ñ –ø–æ–º–∏–ª–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è –≤ –ª–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
3. **Idempotent –æ–ø–µ—Ä–∞—Ü—ñ—è** - –º–µ—Ç–æ–¥ `_sync_to_finance_shipment()` –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –±–∞–≥–∞—Ç–æ —Ä–∞–∑—ñ–≤ –±–µ–∑ –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤

## üìù –§–∞–π–ª–∏ –∑–º—ñ–Ω–µ–Ω–æ:

- `backend/modules/postal_services/service.py`
  - –î–æ–¥–∞–Ω–æ –º–µ—Ç–æ–¥ `_sync_to_finance_shipment()`
  - –û–Ω–æ–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥ `create_shipment()` - –¥–æ–¥–∞–Ω–æ –≤–∏–∫–ª–∏–∫ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
  - –û–Ω–æ–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥ `handle_webhook()` - –¥–æ–¥–∞–Ω–æ –≤–∏–∫–ª–∏–∫ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

---

**–î–∞—Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:** 13.02.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ

