# –ú–æ–¥—É–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ CRM

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
app/
‚îú‚îÄ‚îÄ core/                    # –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º–∏ (–æ–±–æ–≤'—è–∑–∫–æ–≤–µ)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py           # –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ database.py         # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ë–î, —Å–µ—Å—ñ—ó
‚îÇ   ‚îú‚îÄ‚îÄ security.py         # JWT, —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤
‚îÇ   ‚îî‚îÄ‚îÄ middleware.py       # CORS —Ç–∞ —ñ–Ω—à—ñ middleware
‚îÇ
‚îú‚îÄ‚îÄ modules/                 # –ù–µ–∑–∞–ª–µ–∂–Ω—ñ –¥–æ–º–µ–Ω–∏ (–º–æ–∂–Ω–∞ –≤–º–∏–∫–∞—Ç–∏/–≤–∏–º–∏–∫–∞—Ç–∏)
‚îÇ   ‚îú‚îÄ‚îÄ auth/               # üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è (RBAC)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router.py       # /auth/* endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py # get_current_user_db, require_admin
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ communications/     # üí¨ Unified Inbox (Telegram, Meta, Email)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.py       # /communications/* endpoints
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ crm/                # üë• –ö–ª—ñ—î–Ω—Ç–∏, –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è, KP (Workflow)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.py       # /crm/* endpoints
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ finance/            # üí∞ –û–ø–ª–∞—Ç–∏, P24, Stripe, –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.py       # /finance/* endpoints
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ analytics/          # üìä –î–∞—à–±–æ—Ä–¥–∏, –º–µ—Ç—Ä–∏–∫–∏, –∑–≤—ñ—Ç–∏
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ router.py       # /analytics/* endpoints
‚îÇ
‚îú‚îÄ‚îÄ tasks/                  # –§–æ–Ω–æ–≤—ñ –∑–∞–¥–∞—á—ñ (Celery/Arq)
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ
‚îú‚îÄ‚îÄ main.py                 # –°—Ç–∞—Ä–∏–π entry point (legacy)
‚îú‚îÄ‚îÄ main_refactored.py      # –ù–æ–≤–∏–π –º–æ–¥—É–ª—å–Ω–∏–π entry point
‚îú‚îÄ‚îÄ models.py               # SQLAlchemy –º–æ–¥–µ–ª—ñ (–±—É–¥–µ —Ä–æ–∑–±–∏—Ç–æ –ø–æ –º–æ–¥—É–ª—è—Ö)
‚îú‚îÄ‚îÄ schema.py               # Pydantic —Å—Ö–µ–º–∏ (–±—É–¥–µ —Ä–æ–∑–±–∏—Ç–æ –ø–æ –º–æ–¥—É–ª—è—Ö)
‚îú‚îÄ‚îÄ routes.py               # –°—Ç–∞—Ä—ñ —Ä–æ—É—Ç–∏ (legacy, –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ)
‚îî‚îÄ‚îÄ crud.py                 # CRUD –æ–ø–µ—Ä–∞—Ü—ñ—ó (–±—É–¥–µ —Ä–æ–∑–±–∏—Ç–æ –ø–æ –º–æ–¥—É–ª—è—Ö)
```

## –ü—Ä–∏–Ω—Ü–∏–ø–∏ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

### 1. Domain-Driven Design (Lite)
–ö–æ–∂–µ–Ω –º–æ–¥—É–ª—å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ —Å–≤—ñ–π –¥–æ–º–µ–Ω:
- **auth** - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ, —Ä–æ–ª—ñ, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É
- **communications** - –≤—Å—ñ –∫–∞–Ω–∞–ª–∏ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ–π
- **crm** - –∫–ª—ñ—î–Ω—Ç–∏ —Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
- **finance** - —Ñ—ñ–Ω–∞–Ω—Å–∏ —Ç–∞ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è
- **analytics** - –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ç–∞ –∑–≤—ñ—Ç–∏

### 2. –ù–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –º–æ–¥—É–ª—ñ–≤
–ú–æ–¥—É–ª—ñ –º–æ–∂–Ω–∞:
- ‚úÖ –í–º–∏–∫–∞—Ç–∏/–≤–∏–º–∏–∫–∞—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ–º—É—Å—å –Ω–µ —Ç—Ä–µ–±–∞ Telegram)
- ‚úÖ –†–æ–∑–≥–æ—Ä—Ç–∞—Ç–∏ –æ–∫—Ä–µ–º–æ (–º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É)
- ‚úÖ –¢–µ—Å—Ç—É–≤–∞—Ç–∏ —ñ–∑–æ–ª—å–æ–≤–∞–Ω–æ
- ‚úÖ –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø—ñ–¥ —ñ–Ω—à—ñ –±—ñ–∑–Ω–µ—Å–∏

### 3. Core - –æ–±–æ–≤'—è–∑–∫–æ–≤–µ —è–¥—Ä–æ
- Database connection
- Configuration management
- Security (JWT, password hashing)
- Middleware (CORS)

### 4. –ú–æ–¥—É–ª—ñ - –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –±–ª–æ–∫–∏
–ö–æ–∂–µ–Ω –º–æ–¥—É–ª—å –º–∞—î:
- –°–≤—ñ–π router –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º (`/auth`, `/crm`, —Ç–æ—â–æ)
- –°–≤–æ—ó –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (dependencies)
- –°–≤–æ—ó –º–æ–¥–µ–ª—ñ —Ç–∞ —Å—Ö–µ–º–∏ (–±—É–¥–µ –¥–æ–¥–∞–Ω–æ)

## –ú—ñ–≥—Ä–∞—Ü—ñ—è –∑ –º–æ–Ω–æ–ª—ñ—Ç—É

### –ï—Ç–∞–ø 1: –°—Ç–≤–æ—Ä–µ–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚úÖ
- [x] Core –º–æ–¥—É–ª—å (config, database, security, middleware)
- [x] –ú–æ–¥—É–ª—ñ auth, communications, crm, finance, analytics
- [x] –ù–æ–≤–∏–π main_refactored.py

### –ï—Ç–∞–ø 2: –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è –∫–æ–¥—É (TODO)
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ auth routes –∑ routes.py –≤ modules/auth/
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ client/KP routes –≤ modules/crm/
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ email/telegram –≤ modules/communications/
- [ ] –†–æ–∑–±–∏—Ç–∏ models.py –ø–æ –º–æ–¥—É–ª—è—Ö
- [ ] –†–æ–∑–±–∏—Ç–∏ schema.py –ø–æ –º–æ–¥—É–ª—è—Ö
- [ ] –†–æ–∑–±–∏—Ç–∏ crud.py –ø–æ –º–æ–¥—É–ª—è—Ö

### –ï—Ç–∞–ø 3: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î
- [ ] –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π routes.py
- [ ] –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ main_refactored.py –≤ main.py

## –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—å–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó:
```bash
uvicorn app.main_refactored:app --reload
```

### –í–∏–º–∫–Ω—É—Ç–∏ –º–æ–¥—É–ª—å:
–ü—Ä–æ—Å—Ç–æ –∑–∞–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ —Ä—è–¥–æ–∫ –≤ `main_refactored.py`:
```python
# app.include_router(finance_router)  # –í–∏–º–∫–Ω–µ–Ω–æ —Ñ—ñ–Ω–∞–Ω—Å–∏
```

### –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –º–æ–¥—É–ª—å:
1. –°—Ç–≤–æ—Ä–∏—Ç–∏ `app/modules/new_module/`
2. –î–æ–¥–∞—Ç–∏ `router.py` –∑ `APIRouter(prefix="/new_module")`
3. –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≤ `main_refactored.py`:
   ```python
   from modules.new_module.router import router as new_module_router
   app.include_router(new_module_router)
   ```

## –ü–µ—Ä–µ–≤–∞–≥–∏

‚úÖ **–ú–æ–¥—É–ª—å–Ω—ñ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–¥–∞–≤–∞—Ç–∏/–≤–∏–¥–∞–ª—è—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª  
‚úÖ **–¢–µ—Å—Ç–æ–≤–∞–Ω—ñ—Å—Ç—å** - –∫–æ–∂–µ–Ω –º–æ–¥—É–ª—å —Ç–µ—Å—Ç—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–æ  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å** - –º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –º–æ–¥—É–ª—ñ –≤ –æ–∫—Ä–µ–º—ñ —Å–µ—Ä–≤—ñ—Å–∏  
‚úÖ **–ü–æ–≤—Ç–æ—Ä–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è** - –º–æ–¥—É–ª—ñ –º–æ–∂–Ω–∞ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ –º—ñ–∂ –ø—Ä–æ—î–∫—Ç–∞–º–∏  
‚úÖ **–ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥—É** - –Ω–µ–º–∞—î "Big Ball of Mud"

